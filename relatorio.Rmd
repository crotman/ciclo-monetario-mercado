---
title: "Untitled"
author: "André"
date: "2023-07-20"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(shiny)


```



```{r}

dados_juros = read_rds("dados-preparados/dados_juros.rds")
dados_preco = read_rds("dados-preparados/dados_preco.rds")


dados_receita = read_rds("dados-preparados/dados_receita.rds") %>% 
    mutate(
        receita = as.numeric(receita)
    ) %>% 
    filter(receita != 0) %>% 
    filter(
        !str_detect(ticker, "BRAP4")
    ) %>% 
    filter(
        !str_detect(ticker, "BRAP3")
    )
    



#2002 - 2006
#2009 - 2011
#2015 - 2018


data_inicial <- lubridate::floor_date(min(dados_receita$datas), "month")

data_final <- lubridate::floor_date(max(dados_receita$datas), "month")


datas_analise <- tibble(
    data = seq.Date(data_inicial, data_final, by = "day")
    ) %>% 
    cross_join(
        dados_receita %>% select(ticker) %>%  distinct()
    )


dados_receita_completos <- dados_receita %>% 
    right_join(
        datas_analise,
        by = join_by(
            datas == data,
            ticker == ticker
        )
    ) %>% 
    mutate(
        data_referencia = make_date(year(datas) + 1, 12 ,31)
    ) %>% 
    arrange(datas) %>% 
    group_by(ticker, data_referencia) %>% 
    mutate(
        n_obs = sum(!is.na(receita))
    ) %>%
    ungroup() %>% 
    filter(
        n_obs >= 1
    ) %>% 
    group_by(ticker, data_referencia) %>% 
    fill(
        receita,
        .direction = "down"
    ) %>% 
    fill(
        receita,
        .direction = "up"
    ) %>% 
    ungroup() %>% 
    arrange(datas) %>% 
    mutate(
        crescimento_receita = receita / lag(receita) - 1,
        .by = c(ticker, data_referencia)
    ) %>% 
    replace_na(
        list(crescimento_receita = 0)
    ) %>% 
    mutate(
        indice_receita = cumprod(1 + crescimento_receita),
        .by = ticker
    )



receita_equal <- dados_receita_completos %>% 
    summarise(
        crescimento_receita = mean(crescimento_receita),
        .by = datas
    ) %>% 
    mutate(
        indice_receitas = cumprod(1 + crescimento_receita)
    )


receita_ponderada <- dados_receita_completos %>% 
    summarise(
        crescimento_receita = weighted.mean(crescimento_receita, receita),
        .by = datas
    ) %>% 
    mutate(
        indice_receitas = cumprod(1 + crescimento_receita)
    )



monta_indice_real <- function(
        data_inicio_ciclo = 2002, 
        data_fim_ciclo = 2006, 
        inicio_impacto = 0.5, #em relação ao tamanho do ciclo
        final_impacto_meses = 12
){

    datas_no_ciclo <- tibble(
        data = seq(make_date(data_inicio_ciclo,1,1), make_date(data_fim_ciclo,1,1), by = "month" )
    ) %>% 
        slice_tail(prop = 0.5)
    
    datas_impacto = tibble(
        data = seq(
            datas_no_ciclo$data %>% last() %>% lubridate::add_with_rollback(months(1)), 
            length.out = final_impacto_meses,
            by = "month"
        ) 
    )


}



```





```{r}


inputPanel(
    
  selectInput(
      inputId = "ticker", 
      label = "Ticker:",
      multiple = FALSE,
      choices = dados_receita$ticker %>%  unique() %>%  sort()
    )
  
)



receita_filtrada = reactive({
   
    dados_receita_completos %>% 
        filter(ticker %in% input$ticker )
}) 


renderPlot({
    
 
    ggplot(receita_filtrada()) +
        geom_line(
            aes(
                x = datas,
                y = indice_receita
            )
        )
       
    
})



```


```{r}


renderPlot({
    
 
    ggplot(receita_equal) +
        ggtitle("receita equal") +
        geom_line(
            aes(
                x = datas,
                y = indice_receitas
            )
        )
       
    
})




```



```{r}


renderPlot({
    
 
    ggplot(receita_ponderada) +
        ggtitle("receita ponderada") +
        geom_line(
            aes(
                x = datas,
                y = indice_receitas
            )
        )
       
    
})




```






